<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cement Australia Supply Chain Simulation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .container { max-width: 900px; padding-top: 40px; padding-bottom: 40px; }
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        .card-header {
            background: rgba(255,255,255,0.08);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px 16px 0 0 !important;
        }
        h1 { color: #4fc3f7; font-weight: 300; }
        h5 { color: #81d4fa; }
        .form-label { color: #b0bec5; font-weight: 500; }
        .form-control, .form-select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(255,255,255,0.15);
            border-color: #4fc3f7;
            color: #fff;
            box-shadow: 0 0 0 3px rgba(79,195,247,0.2);
        }
        .form-check-input {
            background-color: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.3);
        }
        .form-check-input:checked {
            background-color: #4fc3f7;
            border-color: #4fc3f7;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            border: none;
            font-weight: 600;
            padding: 12px 32px;
            border-radius: 8px;
        }
        .btn-primary:hover { background: linear-gradient(135deg, #29b6f6 0%, #03a9f4 100%); }
        .btn-primary:disabled { opacity: 0.6; }
        .btn-outline-light {
            border-color: rgba(255,255,255,0.3);
            color: #b0bec5;
        }
        .btn-outline-light:hover {
            background: rgba(255,255,255,0.1);
            border-color: #4fc3f7;
            color: #4fc3f7;
        }
        .output-log {
            background: #0d1117;
            color: #58a6ff;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            padding: 16px;
        }
        .spinner-border { width: 1.2rem; height: 1.2rem; }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-ready { background: #2e7d32; color: #a5d6a7; }
        .status-pending { background: #f57c00; color: #ffe0b2; }
        .file-list a { color: #4fc3f7; text-decoration: none; }
        .file-list a:hover { text-decoration: underline; }
        .text-muted { color: #9e9e9e !important; }
        .form-check-label { color: #e0e0e0; }
        .accordion-button {
            background: rgba(255,255,255,0.08);
            color: #81d4fa;
            border: none;
        }
        .accordion-button:not(.collapsed) {
            background: rgba(79,195,247,0.15);
            color: #4fc3f7;
        }
        .accordion-button:focus { box-shadow: none; }
        .accordion-button::after {
            filter: invert(1);
        }
        .accordion-item {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .accordion-body {
            background: rgba(255,255,255,0.03);
            padding: 1rem;
        }
        .nav-tabs {
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-tabs .nav-link {
            color: #9e9e9e;
            border: none;
            padding: 8px 16px;
        }
        .nav-tabs .nav-link:hover {
            color: #4fc3f7;
            border: none;
        }
        .nav-tabs .nav-link.active {
            background: rgba(79,195,247,0.15);
            color: #4fc3f7;
            border: none;
            border-radius: 6px 6px 0 0;
        }
        .param-table {
            font-size: 13px;
            width: 100%;
        }
        .param-table th {
            background: rgba(255,255,255,0.08);
            color: #81d4fa;
            padding: 8px;
            font-weight: 500;
            position: sticky;
            top: 0;
        }
        .param-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .param-table input {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            width: 100%;
            font-size: 12px;
        }
        .param-table input:focus {
            background: rgba(255,255,255,0.15);
            border-color: #4fc3f7;
            outline: none;
        }
        .param-table input[readonly] {
            background: rgba(255,255,255,0.05);
            color: #9e9e9e;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="mb-2">Cement Australia</h1>
            <p class="text-muted">Supply Chain Simulation Dashboard</p>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Simulation Settings</h5>
            </div>
            <div class="card-body">
                <form id="simForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Simulation Horizon (Days)</label>
                            <input type="number" class="form-control" id="horizon_days" 
                                   value="{{ config.horizon_days }}" min="1" max="730">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Random Seed (optional)</label>
                            <input type="number" class="form-control" id="random_seed" 
                                   placeholder="Leave blank for random"
                                   value="{{ config.random_seed if config.random_seed else '' }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="random_opening" {% if config.random_opening %}checked{% endif %}>
                                <label class="form-check-label" for="random_opening">
                                    Random Opening Stock
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary" id="runBtn">
                            <span id="runBtnText">Run Simulation</span>
                            <span id="runBtnSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Model Parameters</h5>
                <small class="text-muted">Edit values below before running simulation</small>
            </div>
            <div class="card-body p-0">
                <div class="accordion" id="paramAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStore">
                                Storage Locations
                            </button>
                        </h2>
                        <div id="collapseStore" class="accordion-collapse collapse" data-bs-parent="#paramAccordion">
                            <div class="accordion-body">
                                <div class="table-container">
                                    <table class="param-table" id="storeTable">
                                        <thead>
                                            <tr>
                                                <th>Location</th>
                                                <th>Equipment</th>
                                                <th>Input</th>
                                                <th>Capacity</th>
                                                <th>Opening (High)</th>
                                                <th>Opening (Low)</th>
                                                <th>Load Rate</th>
                                                <th>Unload Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody id="storeTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseShip">
                                Ship Routes
                            </button>
                        </h2>
                        <div id="collapseShip" class="accordion-collapse collapse" data-bs-parent="#paramAccordion">
                            <div class="accordion-body">
                                <div class="table-container">
                                    <table class="param-table" id="shipTable">
                                        <thead>
                                            <tr>
                                                <th>Origin</th>
                                                <th>Route Group</th>
                                                <th># Vessels</th>
                                                <th>Speed (knots)</th>
                                                <th># Hulls</th>
                                                <th>Payload/Hull</th>
                                            </tr>
                                        </thead>
                                        <tbody id="shipTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4" id="outputCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Simulation Output</h5>
                <span id="statusBadge" class="status-badge"></span>
            </div>
            <div class="card-body">
                <pre class="output-log" id="outputLog"></pre>
            </div>
        </div>

        <div class="card" id="resultsCard" {% if not outputs_exist %}style="display: none;"{% endif %}>
            <div class="card-header">
                <h5 class="mb-0">Results</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <a href="/report" target="_blank" class="btn btn-outline-light" id="viewReportBtn">
                        View Interactive Report
                    </a>
                </div>
                <div class="file-list" id="csvFileList">
                    <small class="text-muted">Download CSV files:</small>
                    <div class="mt-2" id="csvLinks">
                        {% for file in csv_files %}
                        <a href="/outputs/{{ file }}" class="me-3">{{ file }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Model parameters from server
        const modelParams = {{ model_params | tojson | safe }};
        
        // Populate Store table
        function populateStoreTable() {
            const tbody = document.getElementById('storeTableBody');
            tbody.innerHTML = '';
            (modelParams.store || []).forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${row.Location || ''}" readonly></td>
                    <td><input type="text" value="${row['Equipment Name'] || ''}" readonly></td>
                    <td><input type="text" value="${row.Input || ''}" readonly></td>
                    <td><input type="number" data-field="Silo Max Capacity" data-idx="${idx}" value="${row['Silo Max Capacity'] || 0}"></td>
                    <td><input type="number" data-field="Silo Opening Stock (High)" data-idx="${idx}" value="${row['Silo Opening Stock (High)'] || 0}"></td>
                    <td><input type="number" data-field="Silo Opening Stock (Low)" data-idx="${idx}" value="${row['Silo Opening Stock (Low)'] || 0}"></td>
                    <td><input type="number" data-field="Load Rate (ton/hr)" data-idx="${idx}" value="${row['Load Rate (ton/hr)'] || 0}"></td>
                    <td><input type="number" data-field="Unload Rate (ton/hr)" data-idx="${idx}" value="${row['Unload Rate (ton/hr)'] || 0}"></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Populate Ship table
        function populateShipTable() {
            const tbody = document.getElementById('shipTableBody');
            tbody.innerHTML = '';
            (modelParams.move_ship || []).forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${row['Origin Location'] || ''}" readonly></td>
                    <td><input type="text" value="${row['Route Group'] || ''}" readonly></td>
                    <td><input type="number" data-field="# Vessels" data-idx="${idx}" value="${row['# Vessels'] || 0}"></td>
                    <td><input type="number" data-field="Route avg Speed (knots)" data-idx="${idx}" value="${row['Route avg Speed (knots)'] || 0}" step="0.1"></td>
                    <td><input type="number" data-field="#Hulls" data-idx="${idx}" value="${row['#Hulls'] || 0}"></td>
                    <td><input type="number" data-field="Payload per Hull" data-idx="${idx}" value="${row['Payload per Hull'] || 0}"></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // Update model params when inputs change
        document.addEventListener('change', function(e) {
            if (e.target.matches('#storeTableBody input[data-field]')) {
                const idx = parseInt(e.target.dataset.idx);
                const field = e.target.dataset.field;
                modelParams.store[idx][field] = parseFloat(e.target.value) || 0;
            }
            if (e.target.matches('#shipTableBody input[data-field]')) {
                const idx = parseInt(e.target.dataset.idx);
                const field = e.target.dataset.field;
                modelParams.move_ship[idx][field] = parseFloat(e.target.value) || 0;
            }
        });
        
        // Initialize tables
        populateStoreTable();
        populateShipTable();

        document.getElementById('simForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const runBtn = document.getElementById('runBtn');
            const runBtnText = document.getElementById('runBtnText');
            const runBtnSpinner = document.getElementById('runBtnSpinner');
            const outputCard = document.getElementById('outputCard');
            const outputLog = document.getElementById('outputLog');
            const statusBadge = document.getElementById('statusBadge');
            const resultsCard = document.getElementById('resultsCard');
            
            // Reset UI
            outputLog.textContent = '';
            outputCard.style.display = 'block';
            statusBadge.textContent = 'Running';
            statusBadge.className = 'status-badge status-pending';

            runBtn.disabled = true;
            runBtnText.textContent = 'Running...';
            runBtnSpinner.classList.remove('d-none');

            // Build SSE URL with query params
            const horizon = parseInt(document.getElementById('horizon_days').value);
            const ro = document.getElementById('random_opening').checked;
            const rs = document.getElementById('random_seed').value;
            const params = new URLSearchParams({
                horizon_days: String(isNaN(horizon) ? 365 : horizon),
                random_opening: ro ? 'true' : 'false',
                random_seed: rs || ''
            });
            const url = '/stream-simulation?' + params.toString();

            // Close any previous stream
            if (window.__simStream) {
                try { window.__simStream.close(); } catch (e) {}
                window.__simStream = null;
            }

            try {
                const es = new EventSource(url);
                window.__simStream = es;

                // Helper to append a line if it's not a duplicate of the last line
                function appendLine(msg){
                    if (!msg) return;
                    const text = outputLog.textContent;
                    const lastNewline = text.lastIndexOf('\n', text.length - 2);
                    const lastLine = lastNewline >= 0 ? text.slice(lastNewline + 1).trim() : text.trim();
                    if (msg.trim() !== lastLine) {
                        outputLog.textContent += msg + "\n";
                        outputLog.scrollTop = outputLog.scrollHeight;
                    }
                }

                es.addEventListener('start', (ev) => {
                    appendLine(ev.data || 'Simulation started');
                });

                es.addEventListener('progress', (ev) => {
                    const msg = ev.data || '';
                    appendLine(msg);
                    // Extract percent if present
                    const m = msg.match(/Progress:\s*(\d+)%/);
                    if (m) {
                        statusBadge.textContent = m[1] + '%';
                    }
                });

                es.onmessage = (ev) => {
                    if (!ev.data) return;
                    appendLine(ev.data);
                };

                es.addEventListener('done', async (ev) => {
                    try { es.close(); } catch (e) {}
                    window.__simStream = null;
                    let payload = {};
                    try { payload = JSON.parse(ev.data || '{}'); } catch (e) {}
                    const ok = !!payload.success;
                    statusBadge.textContent = ok ? 'Complete' : 'Error';
                    statusBadge.className = 'status-badge ' + (ok ? 'status-ready' : 'status-pending');
                    runBtn.disabled = false;
                    runBtnText.textContent = 'Run Simulation';
                    runBtnSpinner.classList.add('d-none');
                    // Refresh results section
                    try {
                        const st = await fetch('/api/status').then(r => r.json());
                        if (st && (st.report_exists || (payload && payload.report_ready))) {
                            resultsCard.style.display = '';
                            // Make View Report button blue when report is ready
                            const viewReportBtn = document.getElementById('viewReportBtn');
                            if (viewReportBtn && ok) {
                                viewReportBtn.classList.remove('btn-outline-light');
                                viewReportBtn.classList.add('btn-primary');
                            }
                        }
                        const csvLinks = document.getElementById('csvLinks');
                        if (csvLinks && st && Array.isArray(st.csv_files)) {
                            csvLinks.innerHTML = st.csv_files.map(fn => `<a href="/outputs/${fn}" class="me-3">${fn}</a>`).join('');
                        }
                    } catch (e) {}
                });

                es.addEventListener('error', (ev) => {
                    // Generic error handler
                    outputLog.textContent += 'Stream error.\n';
                    outputLog.scrollTop = outputLog.scrollHeight;
                });
            } catch (err) {
                outputLog.textContent += 'Failed to start stream: ' + err.message + '\n';
                statusBadge.textContent = 'Error';
                statusBadge.className = 'status-badge status-pending';
                runBtn.disabled = false;
                runBtnText.textContent = 'Run Simulation';
                runBtnSpinner.classList.add('d-none');
            }
        });
    </script>
</body>
</html>
